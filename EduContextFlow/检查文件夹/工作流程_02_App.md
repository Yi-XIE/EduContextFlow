# ğŸ App ç¼–æ’å±‚ï¼šæ·±åº¦é€»è¾‘æ‹†è§£ï¼ˆåŠ å¼ºç‰ˆï¼‰

App å±‚ï¼ˆ`app.py`ï¼‰æ˜¯ç³»ç»Ÿçš„â€œç¼–æ’ä¸­æ¢â€ã€‚å®ƒä¸åšå†…å®¹ç”Ÿæˆï¼Œä¹Ÿä¸åšæ„å›¾æ¨ç†ï¼Œè€Œæ˜¯**æ‰§è¡Œ Dispatcher çš„å†³ç­–**ã€**è¯»å–ä¸Šä¸‹æ–‡**ã€**æ‹¼æ¥è¾“å…¥**ã€**è°ƒåº¦ Executor** å¹¶å°†äº§ç‰©å›å†™åˆ°æ€»çº¿ã€‚

ä¸‹é¢ä»¥ä»£ç è·¯å¾„ä¸ºä¸»çº¿ï¼Œé€å±‚å±•å¼€ã€‚

---

## 1. è¯·æ±‚å…¥å£ä¸åŸºç¡€é¢„å¤„ç†

**å…¥å£å‡½æ•°**ï¼š`chat()`

- è¯»å–ç”¨æˆ·è¾“å…¥ï¼š
  - `message = request.form.get("message", "").strip()`
  - `files = request.files.getlist("files")`
- å­˜å‚¨ä¸Šä¼ æ–‡ä»¶åˆ° `uploads/`ï¼ˆä¸ä¸Šä¸‹æ–‡æ— å…³ï¼Œåªæ˜¯æ–‡ä»¶è½ç›˜ï¼‰ã€‚
- å¦‚æœæ—¢æ— æ–‡æœ¬ä¹Ÿæ— æ–‡ä»¶ â†’ ç›´æ¥è¿”å› 400ã€‚

**å…³é”®æ„ä¹‰**ï¼šApp å±‚åªåšâ€œè¾“å…¥æ”¶é›†â€ï¼Œä¸è§£é‡Šè¯­ä¹‰ã€‚

---

## 2. æ€»çº¿çŠ¶æ€å¿«ç…§ä¸â€œè¯­ä¹‰é”â€æ³¨å…¥

**å¯¹åº”ä»£ç **ï¼š
```python
bus = GlobalStateBus(STATE_PATH)
state = bus.get_state()

if message:
    bus.set_pending_input(message)
```

- `state` æ˜¯**å½“å‰æ—¶åˆ»çš„å…¨å±€å¿«ç…§**ï¼ˆåŒ…æ‹¬ `context_index`ã€`skills`ã€`stage`ï¼‰ã€‚
- `pending_user_input` æ˜¯â€œè¯­ä¹‰é”â€â€”â€”åªä¿å­˜**å½“å‰è½®æ¬¡**çš„ç”¨æˆ·åŸæ–‡ã€‚

**å…³é”®æ„ä¹‰**ï¼š
- App ä¸ä¿¡ä»»å…¨å±€å˜é‡ï¼Œåªä¿¡ä»» Busã€‚
- å½“å‰è¯·æ±‚çš„çœŸå®ç”¨æˆ·æ„å›¾è¢«é”å®šï¼Œé¿å…â€œå¤šè½®æ±¡æŸ“â€ã€‚

---

## 3. ç»Ÿä¸€å†³ç­–å…¥å£ï¼ˆDispatcher ä¸åªæ˜¯å‡†å…¥ï¼‰

**è°ƒç”¨**ï¼š
```python
result = dispatch(...)
```

**Dispatcher å†³å®šçš„äº‹æƒ…åŒ…æ‹¬**ï¼š
- ä¸‹ä¸€æ­¥æ˜¯ `call_skill / ask_user / refuse / no_action`
- è°ƒç”¨å“ªä¸ª `skill`
- ç»™ç”¨æˆ·çš„ `options`ï¼ˆå€™é€‰è·¯å¾„ï¼‰
- æ˜¯å¦è§¦å‘ä¸‹ä¸€æ­¥æŠ€èƒ½é“¾

**App çš„åŸåˆ™**ï¼š
- **ä¸è‡ªè¡ŒçŒœæµ‹**
- **åªæ‰§è¡Œ Dispatcher çš„åŠ¨ä½œ**

---

## 4. ä¸Šä¸‹æ–‡ç»„è£…ï¼ˆ_prepare_skill_inputï¼‰

### 4.1 requires_context æ˜¯â€œèœå•â€
App ä¸å†³å®šâ€œéœ€è¦å“ªäº›ä¸Šä¸‹æ–‡â€ï¼Œå®ƒåªæ‰§è¡Œï¼š

```
skill.requires_context = ["transcript", "summary", ...]
```

è¿™æ„å‘³ç€ï¼š
- context_index ä¸æ­¢ transcript
- å¯ä»¥åŒ…å« summary / meeting_notes / intent / analysis_result ç­‰ä»»æ„æŠ€èƒ½äº§ç‰©
- App å°†é€ä¸ªè¯»å–è¿™äº›ç±»å‹

### 4.2 å¤šä¸Šä¸‹æ–‡è¯»å–é€»è¾‘ï¼ˆå¾ªç¯è¯»å–ï¼‰
é€»è¾‘æ˜¯ **é€ä¸ª ctx_type è¯»å–å¹¶æ‹¼æ¥**ï¼š

```python
for ctx_type in skill.requires_context:
    ref_path = context_index[ctx_type]["ref"]
    content = read_file(ref_path)
    parts.append(f"=== {ctx_type} ===\n{content}\n")
```

**å…³é”®ç‚¹**ï¼š
- é¡ºåº = requires_context çš„é¡ºåº
- å¯è¯»å¤šä¸ªä¸Šä¸‹æ–‡æ–‡ä»¶

### 4.3 æ‹¼æ¥è§„åˆ™ï¼ˆå¸¦æ ‡ç­¾ + ç”¨æˆ·è¦æ±‚ï¼‰
æœ€ç»ˆè¾“å…¥æ˜¯ï¼š

```
=== transcript ===
[é€å­—ç¨¿å…¨æ–‡]

=== summary ===
[æ‘˜è¦å…¨æ–‡]

=== ç”¨æˆ·è¦æ±‚ ===
[ç”¨æˆ·å½“å‰è¯·æ±‚]
```

**ä½œç”¨**ï¼š
- è®© LLM æ˜ç¡®æ¯æ®µå†…å®¹æ¥æº
- é¿å…æ··æ·†ä¸Šä¸‹æ–‡ç±»å‹

### 4.4 å®¹é”™é€»è¾‘ï¼ˆé˜²æ–­å±‚ï¼‰
å¦‚æœä»»æ„ä¸Šä¸‹æ–‡ç¼ºå¤±æˆ–æ— æ³•è¯»å–ï¼ŒApp ç›´æ¥ä¸­æ­¢ï¼š

```python
if missing_types:
    raise RuntimeError("ä¸Šä¸‹æ–‡æ–‡ä»¶ç¼ºå¤±æˆ–è¯»å–å¤±è´¥")
```

**æ„ä¹‰**ï¼š
- ä¸å…è®¸â€œç©ºä¸Šä¸‹æ–‡â€è¿›å…¥æ‰§è¡Œå™¨
- é˜²æ­¢å‡ºç°â€œæœ‰æ—¶æ²¡æ³¨å…¥â€çš„å‡æˆåŠŸ

---

## 5. æ‰§è¡Œå™¨è°ƒç”¨ä¸äº§ç‰©ç™»è®°

### 5.1 åªè°ƒç”¨ Executor
```python
output_path = execute_skill(skill, input_text)
```

### 5.2 äº§ç‰©ç™»è®°ï¼ˆå…³é”®ï¼‰
```python
bus.mark_skill_done(skill.name, output_path, output_type, description)
```

**è¿™ä¸€è¡Œæ˜¯ä¸Šä¸‹æ–‡é—­ç¯çš„æ ¸å¿ƒ**ï¼š
- æŠŠäº§ç‰©è·¯å¾„å†™å…¥ `context_index`
- ä½¿åç»­æŠ€èƒ½å¯ä»¥å¼•ç”¨
- æ ‡è®°æŠ€èƒ½çŠ¶æ€ä¸º done

---

## 6. è¯­ä¹‰é”é‡Šæ”¾ä¸é—­ç¯

- **æ‰§è¡ŒæˆåŠŸ** â†’ `bus.clear_pending_input()`
- **no_action / refuse** â†’ åŒæ ·æ¸…ç©º
- **ask_user** â†’ ä¸æ¸…ç©ºï¼ˆç­‰å¾…ç”¨æˆ·è¡¥å……ï¼‰

**æ„ä¹‰**ï¼šç¡®ä¿æ¯æ¡ç”¨æˆ·æ„å›¾åªæ¶ˆè´¹ä¸€æ¬¡ã€‚

---

## 7. è¿”å›ç»™å‰ç«¯çš„æ•°æ®ç»“æ„

```json
{
  "reply": "...",
  "output_files": ["outputs/script.md"],
  "options": ["transcript_generation"],
  "bus_state": { ... }
}
```

**App æ˜¯æœ€ç»ˆåŒ…è£…è€…**ï¼š
- æä¾›äº§ç‰©è·¯å¾„
- å›ä¼ æ€»çº¿çŠ¶æ€
- å¸¦ä¸Š Dispatcher çš„é€‰é¡¹

---

## âœ… å…³é”®æµç¨‹æ€»ç»“è¡¨

| é˜¶æ®µ | è´£ä»» | å…³é”®åŠ¨ä½œ | æ˜¯å¦å¯æ›¿ä»£ |
|------|------|---------|------------|
| è¾“å…¥æ¥æ”¶ | App | è¯»å– message/files | å¦ |
| çŠ¶æ€è¯»å– | App | bus.get_state() | å¦ |
| æ„å›¾é”å®š | App | bus.set_pending_input() | å¦ |
| å†³ç­–è§¦å‘ | Dispatcher | è¾“å‡º action/skill/options | å¦ |
| ä¸Šä¸‹æ–‡è¯»å– | App | _prepare_skill_input() | å¦ |
| æ‰§è¡Œè°ƒç”¨ | Executor | execute_skill() | å¦ |
| äº§ç‰©ç™»è®° | App/Bus | mark_skill_done() | å¦ |
| è¯­ä¹‰æ¸…ç† | App | clear_pending_input() | å¦ |

---

## âœ… ä¸€å¥è¯æ€»ç»“

**App å†³å®šâ€œæ‰§è¡Œå™¨çœ‹åˆ°çš„ä¸Šä¸‹æ–‡åˆ°åº•æ˜¯ä»€ä¹ˆâ€**ã€‚
å®ƒä¸å†³å®šâ€œåšä»€ä¹ˆä»»åŠ¡â€ï¼Œä½†å†³å®šâ€œæ‰§è¡Œå™¨åƒåˆ°ä»€ä¹ˆä¸Šä¸‹æ–‡â€ã€‚

