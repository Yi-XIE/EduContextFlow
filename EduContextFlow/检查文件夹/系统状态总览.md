# ğŸ” EduContextFlow ç³»ç»ŸçŠ¶æ€æ£€æŸ¥

**ç”Ÿæˆæ—¶é—´**ï¼š2026-01-19 18:14

---

## ğŸ“‹ ä¸€ã€æ–‡ä»¶ä½ç½®è¯´æ˜

### 1ï¸âƒ£ **æ€»çº¿æ•°æ®æ–‡ä»¶ï¼ˆGlobalStateBusï¼‰**

**æ–‡ä»¶**ï¼š`state.json`ï¼ˆé¡¹ç›®æ ¹ç›®å½•ï¼‰

**ä½œç”¨**ï¼š
- å­˜å‚¨æ•´ä¸ªç³»ç»Ÿçš„çŠ¶æ€
- ç®¡ç† `context_index`ï¼ˆè¯­ä¹‰ä¸Šä¸‹æ–‡ç´¢å¼•ï¼‰
- è®°å½•å·²å®Œæˆçš„æŠ€èƒ½
- ç®¡ç† `pending_user_input`ï¼ˆå¾…æ¶ˆè€—çš„ç”¨æˆ·è¾“å…¥ï¼‰

**å…³é”®å­—æ®µ**ï¼š
```json
{
  "session_id": "ä¼šè¯ID",
  "stage": "å½“å‰é˜¶æ®µ",
  "selected_skill": "é€‰ä¸­çš„æŠ€èƒ½",
  "skills": { "æŠ€èƒ½å": {"status": "done/empty"} },
  "context_index": { "ç±»å‹": {"ref": "æ–‡ä»¶è·¯å¾„", "producer": "ç”Ÿäº§è€…", ...} },
  "pending_user_input": "å¾…å¤„ç†çš„ç”¨æˆ·è¾“å…¥æˆ–null"
}
```

---

### 2ï¸âƒ£ **æ‰§è¡Œå™¨ç”Ÿæˆçš„å†…å®¹æ–‡ä»¶**

**ç›®å½•**ï¼š`outputs/`

**å†…å®¹**ï¼š
- `transcript.md` - æ•™å­¦é€å­—ç¨¿
- `script.md` - è¡¨æ ¼åŒ–æ•™å­¦è§†é¢‘è„šæœ¬
- `question_chain.md` - å¼•å¯¼æ€§é—®é¢˜é“¾
- `image.png` - ç”Ÿæˆçš„æ•™å­¦æ’å›¾
- `image_prompt.txt` - å›¾åƒç”Ÿæˆæç¤ºè¯ï¼ˆLLM ç”Ÿæˆï¼‰
- `image_error.txt` - å›¾åƒç”Ÿæˆé”™è¯¯æ—¥å¿—ï¼ˆå¦‚æœ‰ï¼‰

---

## ğŸ—‚ï¸ äºŒã€å½“å‰æ€»çº¿çŠ¶æ€ï¼ˆcontext_indexï¼‰

ä» `state.json` è¯»å–çš„å½“å‰ä¸Šä¸‹æ–‡ç´¢å¼•ï¼š

| ä¸Šä¸‹æ–‡ç±»å‹ | æ–‡ä»¶è·¯å¾„ | ç”Ÿäº§è€… | çŠ¶æ€ | æè¿° |
|-----------|---------|--------|------|------|
| **transcript** | `outputs/transcript.md` | transcript_generation | âœ… ready | æ•™å­¦é€å­—ç¨¿ |
| **script** | `outputs/script.md` | script_from_transcript | âœ… ready | è¡¨æ ¼åŒ–æ•™å­¦è§†é¢‘è„šæœ¬ |
| **image** | `outputs/image.png` | image_generation | âœ… ready | æ•™å­¦æ’å›¾ |
| **question_chain** | `outputs/question_chain.md` | question_chain_generation | âœ… ready | å¼•å¯¼æ€§é—®é¢˜é“¾ |

**è§£è¯»**ï¼š
- âœ… æ‰€æœ‰ä¸Šä¸‹æ–‡éƒ½å·²ç”Ÿæˆï¼ŒçŠ¶æ€ä¸º `ready`
- âœ… `context_index` æ­£ç¡®è®°å½•äº†æ¯ä¸ªç±»å‹çš„ç”Ÿäº§è€…å’Œå¼•ç”¨è·¯å¾„
- âœ… `pending_user_input` ä¸º `null`ï¼Œè¡¨ç¤ºä¸Šä¸€è½®è¾“å…¥å·²è¢«æ¶ˆè€—

---

## ğŸ“Š ä¸‰ã€ä¸Šä¸‹æ–‡ä¾èµ–å…³ç³»

```
ç”¨æˆ·è¾“å…¥ï¼š"å¸®æˆ‘ç”Ÿæˆä¸€æ®µè®²è§£å…‰åˆä½œç”¨çš„è¯"
    â†“
[transcript] é€å­—ç¨¿ç”Ÿæˆ (transcript_generation)
    â”œâ”€ ref: outputs/transcript.md
    â””â”€ status: ready
        â†“ ä¾èµ–å…³ç³»ï¼šscript_from_transcript.requires_context = ["transcript"]
[script] è„šæœ¬ç”Ÿæˆ (script_from_transcript)
    â”œâ”€ ref: outputs/script.md
    â”œâ”€ è¯»å–ï¼šoutputs/transcript.md (ä» context_index è·å–)
    â””â”€ ç»„è£…è¾“å…¥ï¼šApp å±‚è´Ÿè´£è¯»å– transcript å†…å®¹å¹¶ä¼ é€’ç»™ Executor

ç”¨æˆ·è¾“å…¥ï¼š"å¸®æˆ‘ç”Ÿæˆä¸€å¼ æ£®æ—çš„å›¾ç‰‡"
    â†“
[image] å›¾åƒç”Ÿæˆ (image_generation)
    â”œâ”€ ref: outputs/image.png
    â”œâ”€ requires_context: [] (æ— ä¾èµ–)
    â””â”€ ç‹¬ç«‹ç”Ÿæˆï¼Œä¸è¯»å–å†å²ä¸Šä¸‹æ–‡

ç”¨æˆ·è¾“å…¥ï¼š"æ ¹æ®é€å­—ç¨¿ç”Ÿæˆé—®é¢˜é“¾"
    â†“
[question_chain] é—®é¢˜é“¾ç”Ÿæˆ (question_chain_generation)
    â”œâ”€ ref: outputs/question_chain.md
    â”œâ”€ è¯»å–ï¼šoutputs/transcript.md (ä» context_index è·å–)
    â””â”€ ç»„è£…è¾“å…¥ï¼šApp å±‚è´Ÿè´£è¯»å– transcript å†…å®¹å¹¶ä¼ é€’ç»™ Executor
```

---

## ğŸ”„ å››ã€å®Œæ•´æ•°æ®æµ

### **1. ç”¨æˆ·å‘é€æ¶ˆæ¯**
```
ç”¨æˆ· â†’ Flask API (/api/chat) â†’ app.py
    â†“
bus.set_pending_input(message)  # ä¿å­˜åˆ°æ€»çº¿
```

### **2. Dispatcher å†³ç­–**
```
dispatcher.dispatch(user_message, bus_state, skills)
    â†“
è¯»å– context_indexï¼šæ£€æŸ¥ä¾èµ–æ˜¯å¦æ»¡è¶³
    â”œâ”€ æ»¡è¶³ â†’ return {"action": "call_skill", "skill_name": "..."}
    â””â”€ ä¸æ»¡è¶³ â†’ return {"action": "ask_user", "question": "..."}
```

### **3. App å‡†å¤‡è¾“å…¥**
```
if skill.requires_context:
    # ä» context_index è¯»å–ä¾èµ–æ–‡ä»¶
    for ctx_type in skill.requires_context:
        ref_path = context_index[ctx_type]["ref"]
        content = read_file(ref_path)
    
    # ç»„è£…ï¼šä¸Šä¸‹æ–‡å†…å®¹ + ç”¨æˆ·è¦æ±‚
    input_text = f"=== {ctx_type} ===\n{content}\n\n=== ç”¨æˆ·è¦æ±‚ ===\n{user_message}"
else:
    # æ— ä¾èµ–ï¼Œç›´æ¥ä½¿ç”¨ç”¨æˆ·æ¶ˆæ¯
    input_text = user_message
```

### **4. Executor æ‰§è¡Œ**
```
executor.execute_skill(skill, input_text)
    â†“
1. æ ¼å¼åŒ– prompt: skill.prompt_template.format(user_input=input_text)
2. è°ƒç”¨ LLM: llm.complete(prompt)
3. æ¸…ç†è¾“å‡º: _clean_llm_output(result, input_text)
4. å†™æ–‡ä»¶: write(output_path, cleaned_content)
5. è¿”å›è·¯å¾„: return output_path
```

### **5. æ›´æ–°æ€»çº¿**
```
bus.mark_skill_done(skill_name, output_path, output_type, description)
    â†“
context_index[output_type] = {
    "ref": output_path,
    "producer": skill_name,
    "status": "ready",
    "description": description
}
```

### **6. æ¸…ç©ºè¾“å…¥**
```
bus.clear_pending_input()  # è¾“å…¥å·²è¢«æ¶ˆè€—
```

---

## ğŸ“ äº”ã€æ£€æŸ¥æ–‡ä»¶å¤¹å†…å®¹

æœ¬æ–‡ä»¶å¤¹åŒ…å«ä»¥ä¸‹æ–‡ä»¶ï¼Œæ–¹ä¾¿æ‚¨æ£€æŸ¥ï¼š

### **ç³»ç»ŸçŠ¶æ€**
- âœ… `æ€»çº¿çŠ¶æ€-state.json` - å®Œæ•´çš„æ€»çº¿çŠ¶æ€å¿«ç…§

### **ç”Ÿæˆçš„å†…å®¹**
- âœ… `transcript.md` - æ•™å­¦é€å­—ç¨¿ï¼ˆç”± transcript_generation ç”Ÿæˆï¼‰
- âœ… `script.md` - æ•™å­¦è„šæœ¬ï¼ˆç”± script_from_transcript åŸºäº transcript ç”Ÿæˆï¼‰
- âœ… `question_chain.md` - é—®é¢˜é“¾ï¼ˆç”± question_chain_generation ç”Ÿæˆï¼‰
- âœ… `image_prompt.txt` - å›¾åƒæç¤ºè¯ï¼ˆLLM ç”Ÿæˆçš„è‹±æ–‡æè¿°ï¼‰
- âœ… `ç”Ÿæˆçš„å›¾ç‰‡.png` - æ•™å­¦æ’å›¾ï¼ˆç”± Imagen API ç”Ÿæˆï¼‰

---

## ğŸ¯ å…­ã€å…³é”®éªŒè¯ç‚¹

### âœ… **ä¸Šä¸‹æ–‡å…³è”èƒ½åŠ›**
- `script.md` çš„å†…å®¹åº”è¯¥åŸºäº `transcript.md`
- App å±‚æ­£ç¡®è¯»å–äº† `context_index["transcript"]["ref"]` çš„æ–‡ä»¶å†…å®¹
- Executor æ¥æ”¶åˆ°çš„æ˜¯å®Œæ•´çš„ä¸Šä¸‹æ–‡ + ç”¨æˆ·è¦æ±‚

### âœ… **ä¸Šä¸‹æ–‡éš”ç¦»èƒ½åŠ›**
- `image.png` çš„ç”Ÿæˆä¸ä¾èµ– `transcript` æˆ– `script`
- `image_prompt.txt` ä¸­ä¸åº”åŒ…å«"å…‰åˆä½œç”¨"ã€"åŒå­¦ä»¬"ç­‰å†å²å…³é”®è¯
- æ¯ä¸ªæŠ€èƒ½åªè¯»å–è‡ªå·±å£°æ˜çš„ `requires_context`

### âœ… **è¯­ä¹‰é”æ­£ç¡®æ€§**
- `pending_user_input` åœ¨æŠ€èƒ½å®Œæˆåè¢«æ¸…ç©º
- ä¸å­˜åœ¨å¤šè½®å†å²è¾“å…¥æ±¡æŸ“

---

## ğŸ” ä¸ƒã€å¦‚ä½•æ£€æŸ¥

1. **æŸ¥çœ‹æ€»çº¿çŠ¶æ€**ï¼š
   ```bash
   cat æ€»çº¿çŠ¶æ€-state.json | jq .context_index
   ```

2. **æŸ¥çœ‹ç”Ÿæˆçš„å†…å®¹**ï¼š
   ```bash
   cat transcript.md
   cat script.md
   cat question_chain.md
   ```

3. **éªŒè¯ä¸Šä¸‹æ–‡å…³è”**ï¼š
   - æ‰“å¼€ `transcript.md`ï¼Œè®°ä½å…³é”®å†…å®¹
   - æ‰“å¼€ `script.md`ï¼Œæ£€æŸ¥æ˜¯å¦åŸºäºé€å­—ç¨¿å†…å®¹ç”Ÿæˆ

4. **éªŒè¯ä¸Šä¸‹æ–‡éš”ç¦»**ï¼š
   - æ‰“å¼€ `image_prompt.txt`
   - ç¡®è®¤ä¸åŒ…å« transcript ä¸­çš„å…³é”®è¯ï¼ˆå¦‚"å…‰åˆä½œç”¨"ï¼‰

---

**æ‰€æœ‰æ–‡ä»¶å·²æ•´ç†å®Œæ¯•ï¼è¯·åœ¨æ­¤æ–‡ä»¶å¤¹ä¸­æ£€æŸ¥ã€‚** âœ…

